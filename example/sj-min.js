"undefined"==typeof XMLHttpRequest&&(XMLHttpRequest=function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(e){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}throw new Error("This browser does not support XMLHttpRequest.")}),window.SJ=function(){"use strict";function init(e){return app=e?e:"app",window.SJ.settings={configuration:{canvas:{scope:"FULL",file:"canvas"},texture:{scope:"APP",file:"texture"},sound:{scope:"APP",file:"sound"},scenes:{scope:"APP",file:"scenes"}},modules:{utils:"sj/modules/utils",h4render:"sj/modules/h4render",texture:"sj/modules/texture",canvasobject:"sj/modules/canvasobject",scene:"sj/modules/scene",canvas:"sj/modules/canvas",sound:"sj/modules/sound",input:"sj/modules/input","default":"sj/modules/default",loader:"sj/modules/loader",test:"APP_NAME/modules/test"},init:{module:"test",action:"start"}},window.SJ.config=function(e){var t=e;return function(e,n){return t[e][n]}}({texture:{textures:{background:"img/bg.png",ball:"img/ball.png"}},scenes:{ball_run:{textures:["ball"],sounds:["bump","shot","boom"],objects:{background:{position:{z:1,y:.5,x:.5},rotation:0,dimension:{height:1,width:1},texture:{name:"background",right:1,bottom:1,left:0,top:0}},ball:{position:{z:3,y:.3,x:.5},rotation:2,dimension:{height:.1,width:.1},texture:{name:"ball",right:.5,bottom:.5,left:0,top:0}},crosshair:{position:{z:5,y:-.3,x:.5},rotation:0,dimension:{height:.15,width:.15},texture:{name:"ball",right:1,bottom:.5,left:.5,top:0}}}}},canvas:{fps:20,loader:"sjloader",redner:"h4renderer",canvas_id:"sj-canvas"},sound:{sounds:{bump:"sound/bump.wav",shot:"sound/shot.wav",boom:"sound/boom.wav"}}}),window.SJ.module=function(e,t){window.SJ.settings.modules[e]||console.error("Module "+e+" not found in settings"),window.SJ[e]&&console.error("Cannot reserve name "+e),window.SJ[e]=t(window.SJ)},window.SJ.module("utils",function(e){return{loadImage:function(e){var t=new Image;return t.src=e,t},loadSound:function(e){var t=new Audio(e);return t.load(),t}}}),window.SJ.module("h4render",function(e){function t(e){var t=e.rh4;t.style.top=c*(e.y-e.height/2)+"px",t.style.left=u*(e.x-e.width/2)+"px",t.style.zIndex=1|e.z,e.translated=!1}function n(e){var t=e.rh4;t.style.width=u*e.width+"px",t.style.height=c*e.height+"px",e.scaled=!1}function o(e){e.rh4.style.transform="rotate("+e.rotation+"rad)",e.rotated=!1}function r(e){var t=100/(e.textureRight-e.textureLeft),n=100/(e.textureBottom-e.textureTop),o=e.rh4;o.style.backgroundImage="url('"+e.texture.image.src+"')",o.style.backgroundSize=t+"% "+n+"%",o.style.backgroundPosition=t*e.textureLeft+"% "+n*e.textureTop+"%",e.textured=!1}var i,s,a,u,c;return{init:function(e,t,n){i=e,s=t,a=n,u=i.offsetWidth/t,c=i.offsetHeight/n},start:function(e){for(var s in e.objects){var a=e.objects[s],u=document.createElement("div");u.id="sj-rh4-"+a.name,u.style.position="absolute",a.rh4=u,i.appendChild(u),t(a),n(a),o(a),r(a)}e.started=!0},stop:function(e){e.started=!1;for(var t in e.objects){var n=e.objects[t];i.removeChild(n.rh4),delete n.rh4}},remove:function(e){i.removeChild(e.rh4)},frame:function(e){if(e.started)for(var i in e.objects){var s=e.objects[i];s.translated&&t(s),s.rotated&&o(s),s.textured&&r(s),s.scaled&&n(s)}}}}),window.SJ.module("texture",function(e){function t(){}function n(e){if(!o[e])throw new Error("Texture '"+e+"' not defined!");return!0}var o=e.config("texture","textures"),r={};for(var i in o)r[i]=new t,r[i].name=i;return{load:function(t){n(t)&&!r[t].image&&(r[t].image=e.utils.loadImage(o[t]))},unload:function(e){n(e)&&r[e].image&&delete r[e].image},get:function(e){return n(e)?r[e]:void 0},loaded:function(e){return n(e)?!!r[e].image:void 0}}}),window.SJ.module("canvasobject",function(e){function t(e){var t=this;this.name=e,this.width=1,this.height=1,this.rotation=0,this.x=0,this.y=0,this.z=1,this.setPosition=function(e,n,o){t.x=e,t.y=n,t.z=1|o,t.translated=!0},this.setDimension=function(e,n){this.width=e,this.height=n,t.scaled=!0},this.setRotation=function(e){t.rotation=e,t.rotated=!0},this.setTexture=function(e,n,o,r,i){t.texture=e,t.textureLeft=n,t.textureRight=r,t.textureTop=o,t.textureBottom=i,t.textured=!0}}return{create:function(e){return new t(e)}}}),window.SJ.module("scene",function(e){function t(t,n){var o=this;if(o.objects={},o.sounds={},o.start=function(){var n={};for(var r in o.objects){var i=o.objects[r];i.texture&&!e.texture.loaded(i.texture.name)&&(n[i.texture.name]=!0)}for(var s in n)e.texture.load(s);for(var a in o.sounds)e.sound.load(a);t.start(o)},o.stop=function(){t.stop(o)},o.frame=function(){t.frame(o)},o.createObject=function(t){if(!o.objects[t]){var n=e.canvasobject.create(t);return o.objects[t]=n,n}new Error("Object with name '"+t+"' already exists in scene")},o.removeObject=function(e){o.objects[e]&&(t.remove(o.objects[e]),delete o.objects[e])},o.getObject=function(e){return o.objects[e]},o.attachSound=function(t){if(!o.sounds[t]){var n=e.sound.get(t);return o.sounds[t]=n,n}new Error("Sound with name '"+t+"' already attached scene")},o.dettachSound=function(e){delete o.sounds[e]},o.getSound=function(e){return o.sounds[e]},n&&n.objects)for(var r in n.objects){var i=o.createObject(r),s=n.objects[r];s.position&&i.setPosition(s.position.x,s.position.y,s.position.z),s.rotation&&i.setRotation(s.rotation),s.dimension&&i.setDimension(s.dimension.width,s.dimension.height),s.texture&&i.setTexture(e.texture.get(s.texture.name),s.texture.left,s.texture.top,s.texture.right,s.texture.bottom)}if(n&&n.sounds)for(var a in n.sounds){var u=n.sounds[a];o.attachSound(u)}if(n&&n.textures)for(var c in n.textures)e.texture.load(n.textures[c])}return{create:function(e,n){return new t(e,n)}}}),window.SJ.module("canvas",function(e){function t(){var e=(new Date).getMilliseconds();if(n){var o=s[n];o.onFrame&&o.onFrame(),o.frame()}a&&setTimeout(t,Math.min(1,i-(new Date).getMilliseconds()+e))}var n,o,r=e.config("canvas","fps")||20,i=1e3/r,s={},a=!1,u=document.getElementById(e.config("canvas","canvas_id"));return{init:function(){if(o=e[e.config("canvas","render")||"h4render"],!o)throw new Error("Render not found!");o.init(u,e.config("canvas","width")||1,e.config("canvas","height")||1)},createScene:function(t,n){if(s[t])throw new Error("Scene name '"+t+"' alredy exists");return s[t]=e.scene.create(o,n),s[t]},loadScene:function(t){var o=s[t];if(e.loader.start(u),!o)throw new Error("Scene name '"+t+"' does not exists");n&&(o=s[n],o.onStop&&(o.onStop(),e.loader.progress(u,25)),o.stop()),e.loader.progress(u,50),n=t,o=s[n],o.onStart&&(o.onStart(),e.loader.progress(u,75)),e.loader.progress(u,100),e.loader.finish(u,o.start)},reloadScene:function(){e.canvas.loadScene(n)},getScene:function(e){return s[e]},removeScene:function(e){if(s[e])throw new Error("Scena name '"+e+"' alredy exists");if(n===e)throw new Error("Cannot remove running scene");s[e].onDestroy&&s[e].onDestroy(),s[e].destroy(),delete s[e]},start:function(){a||(a=!0,t())},stop:function(){a&&(a=!1)},getCanvas:function(){return u}}}),window.SJ.module("sound",function(e){function t(){var e=this;e.play=function(){e.sound.currentTime=0,e.sound.play()}}function n(e){if(!o[e])throw new Error("Sound '"+e+"' not defined!");return!0}var o=e.config("sound","sounds"),r={};for(var i in o)r[i]=new t,r[i].name=i;return{load:function(t){n(t)&&!r[t].sound&&(r[t].sound=e.utils.loadSound(o[t]))},unload:function(e){n(e)&&r[e].image&&delete r[e].image},get:function(e){return n(e)?r[e]:void 0},loaded:function(e){return n(e)?!!r[e].image:void 0}}}),window.SJ.module("input",function(e){function t(e,t,n){var o=r[e];o&&(document.removeEventListener(e,o),delete r[e]),r[e]=t,document.addEventListener(e,function(e){n&&e.preventDefault(),t(e.keyCode)})}function n(e,t,n){var a=r[e];a&&(o.removeEventListener(e,a),delete r[e]),r[e]=t,o.addEventListener(e,function(e){n&&e.preventDefault(),t((e.pageX-o.offsetLeft)/i,(e.pageY-o.offsetTop)/s)})}var o=e.canvas.getCanvas(),r={},i=o.offsetWidth/(e.config("canvas","width")||1),s=o.offsetHeight/(e.config("canvas","height")||1);return{KEY_BACKSPACE:8,KEY_TAB:9,KEY_ENTER:13,KEY_SHIFT:16,KET_CTRL:17,KEY_ALT:18,KEY_ESCAPE:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,onKeyDown:function(e,n){t("keydown",e,n)},onKeyUp:function(e,n){t("keyup",e,n)},onMouseMove:function(e,t){n("mousemove",e,t)},onMouseClick:function(e,t){n("click",e,t)}}}),window.SJ.module("default",function(e){return{start:function(){alert("Welcome to sj.js\nI hope you will enjoy it!")}}}),window.SJ.module("loader",function(e){var t,n;return{start:function(e){setTimeout(function(){if(!t){var o,r=document.createElement("div");r.style.fontFamily="'Lucida Console', Monaco, monospace",r.style.position="relative",r.style.textAlign="center",r.style.lineHeight="0px",n=r.cloneNode(),o=r.cloneNode(),r.style.fontSize="20px",r.style.top="45%",r.innerHTML="[SJ.JS]",n.style.fontSize="15px",n.style.top="70%",n.innerHTML="(0%)",o.style.fontSize="10px",o.style.top="85%",o.innerHTML="https://github.com/jagusiak/sj.js",t=e.cloneNode(),t.style.backgroundColor="darkslategrey",t.style.color="white",t.appendChild(r),t.appendChild(n),t.appendChild(o)}e.parentNode.replaceChild(t,e)},1)},progress:function(e,t){setTimeout(function(){n.innerHTML="("+Math.round(t)+"%)"},1)},finish:function(e,n){setTimeout(function(){t.parentNode.replaceChild(e,t),n()},1e3)}}}),window.SJ.module("test",function(e){return{start:function(){var t,n=e.canvas,o=.001,r=.001;n.init(),t=n.createScene("ball_run",e.config("scenes","ball_run")),n.start(),t.onFrame=function(){var e=t.getObject("ball");e&&(e.setRotation(e.rotation+.01),e.setPosition(e.x+o,e.y+r,e.z),(e.x+e.width/2>=1||e.x-e.width/2<=0)&&(o*=-1,t.getSound("bump").play()),(e.y+e.height/2>=1||e.y-e.height/2<=0)&&(r*=-1,t.getSound("bump").play()))},e.input.onMouseMove(function(e,n){var o=t.getObject("crosshair");o.setPosition(e,n,o.z)}),e.input.onMouseClick(function(e,n){var o=(t.getObject("crosshair"),t.getObject("ball"));t.getSound("shot").play(),o&&Math.abs(e-o.x)<o.width&&Math.abs(n-o.y)<o.height&&(t.getSound("boom").play(),t.removeObject("ball"))}),e.input.onKeyDown(function(t){switch(t){case e.input.KEY_LEFT:o*=2;break;case e.input.KEY_RIGHT:o/=2;break;case e.input.KEY_UP:r*=2;break;case e.input.KEY_DOWN:r/=2}}),n.loadScene("ball_run")}}}),setTimeout(window.SJ[window.SJ.settings.init.module][window.SJ.settings.init.action],1),!0}var app,core={settings:"sj/core/settings.js",config:"sj/core/config.js",modules:"sj/core/modules.js",run:"sj/core/run.js"},script=function(){var xhr=new XMLHttpRequest;return xhr.onreadystatechange=function(){this.readyState===(this.DONE||4)&&eval(this.responseText)},{load:function(e){xhr.open("GET",e,!1),xhr.send(null)}}}(),json=function(){var e=new XMLHttpRequest,t=null;return e.onreadystatechange=function(){this.readyState===(this.DONE||4)&&(t=JSON.parse(this.responseText))},{load:function(n){return e.open("GET",n,!1),e.send(null),t}}}();return{init:init,script:script,json:json,getApp:function(){return app}}}();
